
export const UrlInput = () => {
  if (typeof window === 'undefined') return null;

  const [url, setUrl] = React.useState('');

  const sync = (newUrl) => {
    const savedKey = localStorage.getItem('zap_unlocked_api_key');
    const targetUrl = newUrl || localStorage.getItem('zap_unlocked_url');
    if (!savedKey && !targetUrl) return;

    const cleanUrl = targetUrl ? targetUrl.replace(/\/$/, '') : '';
    const urlRegex = new RegExp('https://[a-zA-Z0-9-]+\\.up\\.railway\\.app', 'g');
    const placeholders = ['SUA_SENHA_SECRETA', 'SUA_CHAVE', 'YOUR_SECRET'];

    document.querySelectorAll('code, pre span, a, span.token').forEach(el => {
      if (savedKey && el.children.length === 0 && el.textContent) {
        placeholders.forEach(p => {
          if (el.textContent.includes(p)) {
            el.textContent = el.textContent.replaceAll(p, savedKey);
          }
        });
      }

      if (cleanUrl) {
        if (el.children.length === 0 && el.textContent) {
          if (el.textContent.includes('https://seu-projeto.up.railway.app') || urlRegex.test(el.textContent)) {
            el.textContent = el.textContent.replace('https://seu-projeto.up.railway.app', cleanUrl).replace(urlRegex, cleanUrl);
          }
        }
        if (el.tagName === 'A' && el.href) {
          el.href = el.href.replace('https://seu-projeto.up.railway.app', cleanUrl).replace(urlRegex, cleanUrl);
        }
      }
    });
  };

  const handlePaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text) return;
      
      let finalUrl = text.trim();
      if (finalUrl && !finalUrl.startsWith('http')) finalUrl = 'https://' + finalUrl;
      
      setUrl(finalUrl);
      localStorage.setItem('zap_unlocked_url', finalUrl);
      sync(finalUrl);
      window.dispatchEvent(new Event('apikey_updated'));
    } catch (err) {
      console.error('Falha ao colar:', err);
    }
  };

  React.useEffect(() => {
    const saved = localStorage.getItem('zap_unlocked_url') || '';
    if (saved) setUrl(saved);
    const t = setTimeout(() => sync(saved), 1000);
    const handler = () => sync();
    window.addEventListener('apikey_updated', handler);
    return () => {
      clearTimeout(t);
      window.removeEventListener('apikey_updated', handler);
    };
  }, []);

  return (
    <div className="flex flex-col gap-2 mt-4 bg-primary/5 p-4 rounded-xl border border-primary/10 mb-6 font-sans">
      <label className="text-[13px] font-bold text-primary flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5">
          <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
        </svg>
        Sua URL da Railway
      </label>
      <div className="flex gap-2 items-center">
        <div className="relative flex-1 group">
          <input 
            type="text" 
            placeholder="Clique no ícone para colar"
            value={url}
            readOnly
            className="w-full bg-white dark:bg-gray-900 border border-primary/20 rounded-lg px-3 py-2 text-sm focus:outline-none transition-all font-mono text-primary cursor-default pr-10"
          />
          <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none opacity-40">
             <kbd className="text-[10px] font-sans">readonly</kbd>
          </div>
        </div>
        <button 
          onClick={handlePaste}
          className="p-2.5 rounded-lg bg-primary text-white hover:bg-primary-dark transition-all active:scale-95 flex items-center justify-center shrink-0 shadow-sm gap-2"
          title="Colar da área de transferência (sobrescreve)"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
          <span className="text-xs font-bold uppercase tracking-wider">Colar</span>
        </button>
      </div>
      <p className="text-[11px] text-gray-400 italic">
        Clique em "Colar" para capturar sua URL. O campo é apenas leitura para evitar erros.
      </p>
    </div>
  );
}
